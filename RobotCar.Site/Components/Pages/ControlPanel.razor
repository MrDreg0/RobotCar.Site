@page "/control-panel"
@using System.Timers
@using Microsoft.Extensions.Options
@using RobotCar.Site.Options
@rendermode InteractiveServer
@inject IRobotCarApi RobotCarApi
@inject IOptions<RobotApiOptions> RobotApiOptions

<PageTitle>Control Panel</PageTitle>

@if (_showInitializationWarning)
{
  <div class="position-fixed top-0 start-0 w-100 h-100"
       style="background: rgba(0,0,0,0.45); z-index: 1050;">
    <div class="d-flex align-items-center justify-content-center h-100 px-3">
      <div class="card shadow-lg" role="dialog" aria-modal="true" style="max-width: 420px; width: 100%;">
        <div class="card-body">
          <div class="d-flex align-items-center gap-2 mb-2">
            <i class="bi bi-exclamation-triangle-fill text-warning"></i>
            <h5 class="card-title mb-0">Initialization failed</h5>
          </div>
          <p class="card-text mb-2">
            We couldn't reach the robot, so the initial setup wasn't applied. Check power/WiFi and retry, or
            skip to continue without a device.
          </p>
          @if (!string.IsNullOrWhiteSpace(_lastInitializationError))
          {
            <div class="small text-secondary mb-3">@_lastInitializationError</div>
          }
          <div class="d-flex gap-2 justify-content-end">
            <button class="btn btn-outline-secondary"
                    @onclick="SkipInitializationWarning"
                    disabled="@_isRetryingInitialization">
              Skip
            </button>
            <button class="btn btn-warning"
                    @onclick="RetryInitialization"
                    disabled="@_isRetryingInitialization">
              @(_isRetryingInitialization ? "Retrying..." : "Retry")
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
}

<div class="container mt-3">
  <div class="row justify-content-center">
    <div class="col-12 col-sm-10 col-md-8 col-lg-6 text-center">
      <div class="mb-4">
        <div class="mb-2 d-flex justify-content-center">
          <button class="btn btn-outline-primary" @onclick="ToggleStream">
            @(_streamEnabled ? "Disable Stream" : "Enable Stream")
          </button>
        </div>
        
        <div class="d-flex justify-content-center">
          <div style="width:300px; height:225px; background:#f1f3f5; border:1px solid #dee2e6; border-radius:12px; overflow:hidden;">
            @if (_streamEnabled)
            {
              <img src="@_streamSrc"
                   style="width:100%; height:100%; object-fit:cover; display:block;"
                   alt="camera stream">
            }
            else
            {
              <div class="w-100 h-100 d-flex flex-column justify-content-center align-items-center text-secondary">
                <div class="fw-semibold">Stream Disabled</div>
                <div style="font-size:0.9rem;">Click "Enable Stream"</div>
              </div>
            }
          </div>
        </div>
      </div>
      <div class="d-flex justify-content-center">
        <div class="d-grid gap-2"
             style="grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(3, 60px);">
          <button class="btn btn-primary" style="grid-column:2; grid-row:1"
                  @onmousedown="HandleMoveForward"
                  @onmouseup="HandleStop"
                  @ontouchstart="HandleMoveForward"
                  @ontouchend="HandleStop">
            <i class="bi bi-arrow-up"></i>
          </button>
          <button class="btn btn-primary" style="grid-column:1; grid-row:2"
                  @onmousedown="HandleMoveLeft"
                  @onmouseup="HandleStop"
                  @ontouchstart="HandleMoveLeft"
                  @ontouchend="HandleStop">
            <i class="bi bi-arrow-left"></i>
          </button>
          <button class="btn btn-danger" style="grid-column:2; grid-row:2"
                  @onclick="HandleStop">
            <i class="bi bi-stop-fill"></i>
          </button>
          <button class="btn btn-primary" style="grid-column:3; grid-row:2"
                  @onmousedown="HandleMoveRight"
                  @onmouseup="HandleStop"
                  @ontouchstart="HandleMoveRight"
                  @ontouchend="HandleStop">
            <i class="bi bi-arrow-right"></i>
          </button>
          <button class="btn btn-primary" style="grid-column:2; grid-row:3"
                  @onmousedown="HandleMoveBack"
                  @onmouseup="HandleStop"
                  @ontouchstart="HandleMoveBack"
                  @ontouchend="HandleStop">
            <i class="bi bi-arrow-down"></i>
          </button>
        </div>
      </div>

      <div class="d-flex justify-content-center gap-3 mt-4">
        <button class="btn btn-warning d-flex align-items-center gap-2 px-5"
                id="lightOnBtn"
                @onclick="HandleLedOn">
          <i class="bi bi-lightbulb-fill"></i> ON
        </button>

        <button class="btn btn-secondary d-flex align-items-center gap-2 px-5"
                id="lightOffBtn"
                @onclick="HandleLedOff">
          <i class="bi bi-lightbulb-off-fill"></i> OFF
        </button>
      </div>
        
      <div class="text-start mt-3">
        <p>Motor Power</p>
        <div class="d-flex flex-row mb-3">
          <RangeInput TValue="int" 
                      @bind-Value="_motorPower" 
                      @bind-Value:after="HandleMotorPowerChanged"
                      @onmouseup="HandleMotorPowerChanged"
                      @ontouchend="HandleMotorPowerChanged"
                      Min="30" Max="100"/>
          <Badge Color="BadgeColor.Primary" Class="ms-2" VisuallyHiddenText="_speed">@_motorPower%</Badge>
        </div>
      </div>
    </div>
  </div>
</div>


@code{
  private int _motorPower = 59;
  private readonly TimeSpan _debounceMotorPowerChangeInterval = TimeSpan.FromSeconds(1);
  private readonly TimeSpan _livenessTimeout = TimeSpan.FromSeconds(3);
  
  private bool _streamEnabled;
  private string _streamSrc = "about:blank";
  private bool _showInitializationWarning;
  private bool _initializationSkipped;
  private bool _isRetryingInitialization;
  private string? _lastInitializationError;
  private bool _isRobotAvailable;
  
  private string? _baseAddress;
  private Timer? _debounceMotorPowerChange;

  protected override void OnInitialized()
  {
    _baseAddress = RobotApiOptions.Value.BaseUrl;
    
    if (string.IsNullOrWhiteSpace(_baseAddress))
    {
      throw new InvalidOperationException("Connection string 'RobotApi' not configured.");
    }
    
    base.OnInitialized();
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender)
    {
      await InitializeRobotCarAsync();
    }

    await base.OnAfterRenderAsync(firstRender);
  }

  private async Task HandleMoveForward() => await HandleCommand("go");
  private async Task HandleMoveBack() => await HandleCommand("back");
  private async Task HandleMoveLeft() => await HandleCommand("left");
  private async Task HandleMoveRight() => await HandleCommand("right");
  private async Task HandleStop() => await HandleCommand("stop");

  private async Task HandleLedOff() => await HandleCommand("ledoff");
  private async Task HandleLedOn() => await HandleCommand("ledon");
  
  private void HandleMotorPowerChanged()
  {
    if (!_isRobotAvailable)
    {
      return;
    }

    _debounceMotorPowerChange?.Stop();
    _debounceMotorPowerChange?.Start();
  }
  
  private async Task HandleCommand(string commandName)
  {
    Console.WriteLine(commandName);

    //return Task.CompletedTask;

    try
    {
      await RobotCarApi.SendCommand(commandName);
    }
    catch (Exception e)
    {
      Console.WriteLine($"Command '{commandName}' failed: {e}");
    }
  }
  
  private void InitializeMotorPowerDebounce()
  {
    if (_debounceMotorPowerChange is not null)
    {
      return;
    }

    _debounceMotorPowerChange = new Timer(_debounceMotorPowerChangeInterval);
    _debounceMotorPowerChange.AutoReset = false;
    _debounceMotorPowerChange.Elapsed += async (_, _) =>
    {
      try
      {
        await RobotCarApi.SetMotorPower(_motorPower);
        Console.WriteLine($"MotorPower sent: {_motorPower}");
      }
      catch (Exception e)
      {
        Console.WriteLine($"MotorPower update failed: {e}");
      }
    };
  }
  
  private async Task ToggleStream()
  {
    if (_streamEnabled) StopStream();
    else StartStream();
    
    await InvokeAsync(StateHasChanged);
  }

  private void StartStream()
  {
    _streamEnabled = true;
    _streamSrc = $"{_baseAddress}:81/stream";
  }

  private void StopStream()
  {
    _streamEnabled = false;
    _streamSrc = "about:blank";
  }
  
  private async Task InitializeRobotCarAsync()
  {
    if (_initializationSkipped)
    {
      return;
    }

    try
    {
      using var cts = new CancellationTokenSource(_livenessTimeout);
      var result = await RobotCarApi.CheckLiveness(cts.Token);
      if (result.IsSuccessStatusCode)
      {
        await RobotCarApi.SetMotorPower(_motorPower);
        Console.WriteLine($"Initialization succeeded. MotorPower set to {_motorPower}.");

        _isRobotAvailable = true;
        InitializeMotorPowerDebounce();

        _showInitializationWarning = false;
        _initializationSkipped = false;
        _lastInitializationError = null;
        await InvokeAsync(StateHasChanged);
        return;
      }
        
      var reason = string.IsNullOrWhiteSpace(result.ReasonPhrase)
        ? result.StatusCode.ToString()
        : result.ReasonPhrase;
      await HandleInitializationFailure($"RobotCar is not reachable. {reason}");
    }
    catch (OperationCanceledException)
    {
      await HandleInitializationFailure(
        $"Initialization timed out after {_livenessTimeout.TotalSeconds:0.#}s.");
    }
    catch (Exception e)
    {
      await HandleInitializationFailure($"Initialization error: {e.Message}");
    }
  }

  private async Task HandleInitializationFailure(string message)
  {
    _isRobotAvailable = false;
    _debounceMotorPowerChange?.Stop();
    _showInitializationWarning = true;
    _lastInitializationError = message;
    Console.WriteLine($"Initialization failed: {message}");
    await InvokeAsync(StateHasChanged);
  }

  private async Task RetryInitialization()
  {
    if (_isRetryingInitialization)
    {
      return;
    }

    _isRetryingInitialization = true;
    _lastInitializationError = null;
    await InvokeAsync(StateHasChanged);

    try
    {
      await InitializeRobotCarAsync();
    }
    finally
    {
      _isRetryingInitialization = false;
      await InvokeAsync(StateHasChanged);
    }
  }

  private void SkipInitializationWarning()
  {
    _showInitializationWarning = false;
    _initializationSkipped = true;
  }
}
